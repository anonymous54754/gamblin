<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S SUPER 9 BET | PREMIUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --point-gold: #eebb4d; --bg-dark: #0a0a0a; --panel-bg: #151515; }
        body { background-color: var(--bg-dark); color: #eee; font-family: 'Noto Sans KR', sans-serif; margin: 0; overflow: hidden; }

        /* ê²°ê³¼ íŒì—… */
        #resultPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; 
                       background: #000; border: 3px solid var(--point-gold); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px gold; min-width: 300px; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ê³ ê°ì„¼í„°, ë§ˆì´í˜ì´ì§€ ìš°ìƒë‹¨ ê³ ì •) */
        .top-nav { background: linear-gradient(180deg, #1b5e20, #0a2e10); height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 2px solid #222; position: relative; z-index: 1000; }
        .logo { font-size: 26px; font-weight: 900; color: #fff; cursor: pointer; font-style: italic; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .asset-box { background: #000; padding: 8px 15px; border-radius: 5px; border: 1px solid gold; color: gold; font-weight: 900; font-size: 20px; min-width: 150px; text-align: right; }
        .user-menu { font-size: 14px; display: flex; gap: 15px; }
        .user-menu span { cursor: pointer; color: #bbb; padding: 5px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); }
        .user-menu span:hover { color: gold; }

        /* ë ˆì´ì•„ì›ƒ */
        .main-wrapper { display: flex; height: calc(100vh - 70px); }
        .sidebar { width: 200px; background: #0d0d0d; border-right: 1px solid #222; }
        .menu-item { padding: 20px; cursor: pointer; color: #777; font-weight: 700; transition: 0.3s; border-left: 4px solid transparent; }
        .menu-active { background: #1a1a1a; color: gold; border-left: 4px solid gold; }
        .content { flex: 1; padding: 30px; overflow-y: auto; background: #111; }

        /* ê²Œì„ íŒ¨ë„ */
        .game-panel { background: var(--panel-bg); border-radius: 15px; padding: 30px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn-play { background: linear-gradient(to bottom, #ffd700, #b8860b); color: #000; border: none; padding: 15px 40px; font-weight: 900; border-radius: 5px; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 0 #664d00; }
        .btn-play:active { transform: translateY(2px); box-shadow: none; }

        /* ìŠ¬ë¡¯ ë¨¸ì‹  (ì´ëª¨ì§€ ë²„ì „) */
        .slot-machine { background: #222; border: 6px solid #444; padding: 20px; border-radius: 10px; display: flex; justify-content: center; gap: 15px; margin: 20px auto; width: fit-content; }
        .reel { width: 95px; height: 125px; background: #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 60px; border: 2px solid #000; color: #000; }

        /* ë‹¬íŒ½ì´ ìº”ë²„ìŠ¤ (ê°ˆìƒ‰ íŠ¸ë™) */
        #snailCanvas { background-color: #5d4037; border: 5px solid #3e2723; border-radius: 10px; cursor: crosshair; }

        .view { display: none; }
        .active-view { display: block; }
    </style>
</head>
<body>

    <div id="resultPopup">
        <h1 id="popTitle" style="font-size:45px; margin:0;">WIN</h1>
        <h2 id="popAmount" style="color:white; font-size:30px;">+ 0</h2>
        <button class="btn-play" onclick="closePopup()">í™•ì¸</button>
    </div>

    <div class="top-nav">
        <div class="logo" onclick="showView('lobby')">S SUPER 9 BET</div>
        <div class="nav-right">
            <div class="asset-box">â‚© <span id="assetVal">0</span></div>
            <div class="user-menu">
                <strong id="userNick" style="color:white; margin-right:5px;">ê´€ë¦¬ìë‹˜</strong>
                <span onclick="showView('csCenter')">ê³ ê°ì„¼í„°</span>
                <span onclick="showView('myPage')">ë§ˆì´í˜ì´ì§€</span>
                <span onclick="handleLogout()" style="color:#ff5252;">ë¡œê·¸ì•„ì›ƒ</span>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div id="m-lobby" class="menu-item menu-active" onclick="showView('lobby')">HOME</div>
            <div id="m-slot" class="menu-item" onclick="showView('slotView')">SLOT 777</div>
            <div id="m-bac" class="menu-item" onclick="showView('bacView')">BACCARAT</div>
            <div id="m-snail" class="menu-item" onclick="showView('snailView')">SNAIL RACE</div>
        </div>

        <div class="content">
            <div id="lobby" class="view active-view">
                <div class="game-panel">
                    <h1 style="color:gold; font-size:40px;">PREMIUM CASINO</h1>
                    <p style="font-size:18px;">ì‹¤ì‚¬ ê¸°ë°˜ì˜ ë‹¬íŒ½ì´ ë ˆì´ì‹±ê³¼ ê³ ë°°ë‹¹ ìŠ¬ë¡¯ì„ ê²½í—˜í•˜ì‹­ì‹œì˜¤.</p>
                </div>
            </div>

            <div id="slotView" class="view">
                <div class="game-panel">
                    <h2>ğŸ° MEGA CHANCE SLOT</h2>
                    <div class="slot-machine">
                        <div id="reel1" class="reel">7ï¸âƒ£</div>
                        <div id="reel2" class="reel">ğŸ’</div>
                        <div id="reel3" class="reel">ğŸ’</div>
                    </div>
                    <input type="number" id="slotBet" style="padding:12px; font-size:18px; width:200px; background:#000; color:gold; border:1px solid #444;" value="10000">
                    <button id="slotBtn" class="btn-play" onclick="playSlot()">SPIN START</button>
                </div>
            </div>

            <div id="snailView" class="view">
                <div class="game-panel">
                    <h2>ğŸŒ REAL SNAIL DERBY</h2>
                    <canvas id="snailCanvas" width="700" height="260"></canvas>
                    <div style="margin:20px 0; font-size:18px; font-weight:bold;">
                        <label><input type="radio" name="snailPick" value="0" checked> 1ë²ˆ (ì‹¤ì‚¬)</label>
                        <label style="margin-left:25px;"><input type="radio" name="snailPick" value="1"> 2ë²ˆ (ì‹¤ì‚¬)</label>
                        <label style="margin-left:25px;"><input type="radio" name="snailPick" value="2"> 3ë²ˆ (ì‹¤ì‚¬)</label>
                    </div>
                    <input type="number" id="snailBet" style="padding:12px; font-size:18px; width:200px; background:#000; color:gold; border:1px solid #444;" value="10000">
                    <button id="snailBtn" class="btn-play" onclick="playSnail()">RACE START</button>
                </div>
            </div>
            
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDOVJtg5lxJTBP2Vm1mzbuecKu9Rg-I4k4", authDomain: "gambling-23339.firebaseapp.com", projectId: "gambling-23339", storageBucket: "gambling-23339.firebasestorage.app", messagingSenderId: "1031894079454", appId: "1:1031894079454:web:960ca0f1748493cdd9af4f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userObj = null, curBal = 0, displayedBal = 0;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                userObj = user;
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    curBal = snap.data().balance;
                    displayedBal = curBal;
                    document.getElementById('assetVal').innerText = curBal.toLocaleString();
                    document.getElementById('userNick').innerText = (snap.data().nickname || "ê´€ë¦¬ì") + "ë‹˜";
                }
            } else { location.href = "login.html"; }
        });

        // --- ì± ë¼ë½ ìˆ«ì ì¹´ìš´íŒ… íš¨ê³¼ ---
        function animateValue(start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = Math.floor(progress * (end - start) + start);
                document.getElementById('assetVal').innerText = currentVal.toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        async function syncBalance(profit) {
            const oldBal = curBal;
            curBal += profit;
            await updateDoc(doc(db, "users", userObj.uid), { balance: increment(profit) });
            animateValue(oldBal, curBal, 1000); // 1ì´ˆ ë™ì•ˆ ì± ë¼ë½ ì˜¬ë¼ê°
        }

        // --- ì‹¤ì‚¬ ë‹¬íŒ½ì´ ë¡œì§ ---
        const realSnailImg = new Image();
        realSnailImg.src = "https://cdn.pixabay.com/photo/2012/04/18/17/33/snail-37651_960_720.png";

        let snX = [10, 10, 10];
        window.initSnail = () => {
            const ctx = document.getElementById('snailCanvas').getContext('2d');
            function frame() {
                ctx.clearRect(0,0,700,260);
                // ê°€ì´ë“œ ë¼ì¸
                ctx.strokeStyle = "rgba(255,255,255,0.05)";
                for(let i=1; i<3; i++) { ctx.beginPath(); ctx.moveTo(0, i*85); ctx.lineTo(700, i*85); ctx.stroke(); }
                // ë‹¬íŒ½ì´ ê·¸ë¦¬ê¸°
                snX.forEach((x, i) => {
                    ctx.drawImage(realSnailImg, x, 20 + (i*85), 75, 55);
                });
                if(document.getElementById('snailView').classList.contains('active-view')) requestAnimationFrame(frame);
            }
            frame();
        };

        window.playSnail = async () => {
            const bet = parseInt(document.getElementById('snailBet').value);
            const pick = parseInt(document.querySelector('input[name="snailPick"]:checked').value);
            if(bet > curBal) return alert("ì”ì•¡ ë¶€ì¡±");
            
            document.getElementById('snailBtn').disabled = true;
            const race = setInterval(async () => {
                let winner = -1;
                snX = snX.map((x, i) => {
                    const nx = x + Math.random() * 3.5;
                    if(nx > 610) winner = i;
                    return nx;
                });
                if(winner !== -1) {
                    clearInterval(race);
                    const win = (winner === pick);
                    const profit = win ? (bet * 2.8) - bet : -bet;
                    syncBalance(profit);
                    showPopup(win, profit);
                    snX = [10, 10, 10];
                    document.getElementById('snailBtn').disabled = false;
                }
            }, 30);
        };

        // --- ì´ëª¨ì§€ ìŠ¬ë¡¯ ë¡œì§ ---
        const emojis = ['7ï¸âƒ£', 'ğŸ’', 'ğŸ‹', 'ğŸ‡', 'ğŸ‰', 'ğŸ’'];
        window.playSlot = async () => {
            const bet = parseInt(document.getElementById('slotBet').value);
            if(bet > curBal) return alert("ì”ì•¡ ë¶€ì¡±");
            document.getElementById('slotBtn').disabled = true;

            let count = 0;
            const spin = setInterval(() => {
                document.getElementById('reel1').innerText = emojis[Math.floor(Math.random()*emojis.length)];
                document.getElementById('reel2').innerText = emojis[Math.floor(Math.random()*emojis.length)];
                document.getElementById('reel3').innerText = emojis[Math.floor(Math.random()*emojis.length)];
                count++;
                if(count > 25) {
                    clearInterval(spin);
                    const r1 = document.getElementById('reel1').innerText;
                    const r2 = document.getElementById('reel2').innerText;
                    const r3 = document.getElementById('reel3').innerText;
                    
                    let mul = 0;
                    if(r1 === r2 && r2 === r3) mul = (r1 === '7ï¸âƒ£') ? 50 : 10;
                    else if(r1 === r2 || r2 === r3 || r1 === r3) mul = 2;

                    const profit = (bet * mul) - bet;
                    syncBalance(profit);
                    showPopup(profit >= 0, profit);
                    document.getElementById('slotBtn').disabled = false;
                }
            }, 80);
        };

        // --- ê³µí†µ ê¸°ëŠ¥ ---
        window.showPopup = (isWin, amount) => {
            document.getElementById('popTitle').innerText = isWin ? "WINNER!" : "LOSE";
            document.getElementById('popTitle').style.color = isWin ? "gold" : "#ff5252";
            document.getElementById('popAmount').innerText = (amount >= 0 ? "+" : "") + amount.toLocaleString() + " KRW";
            document.getElementById('resultPopup').style.display = 'block';
        };
        window.closePopup = () => { document.getElementById('resultPopup').style.display = 'none'; };
        window.showView = (vid) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('menu-active'));
            document.getElementById(vid).classList.add('active-view');
            const mId = 'm-' + vid.replace('View','').replace('Center','lobby').replace('myPage','lobby');
            if(document.getElementById(mId)) document.getElementById(mId).classList.add('menu-active');
            if(vid === 'snailView') initSnail();
        };
        window.handleLogout = () => { signOut(auth).then(() => location.href="login.html"); };
    </script>
</body>
</html>